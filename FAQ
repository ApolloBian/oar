FAQ
===

User
----

How can I submit a moldable job?
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

You just have to use several "-l" oarsub_ option(one for each moldable
description). By default the OAR scheduler will launch the moldable job which
will end first.

So you can see some free resources but the scheduler can decide to start your
job later because they will have more free resources and the job walltime will
be smaller.

How can I submit a job with a non uniform description?
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Example:
::
    
    oarsub -I -l '{switch = "sw1" or switch = "sw5"}/switch=1+/node=1'

This example asks OAR to reserve all resources from the switch sw1 or the
switch sw2 **and** a node on another switch.

You can see the "+" syntax as a sub-reservation directive.

Can I perform a fix scheduled reservation and then launch several jobs in it?
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Yes. You have to use the OAR scheduler "timesharing" feature.
To use it, the reservation and your further jobs must be of the type
timesharing (only for you).

Example:

  1. Make your reservation:
     ::
        
        oarsub -r "2006-09-12 8:00:00" -l /switch=1 -t 'timesharing=user,*'

     This command asks all resources from one switch at the given date for the
     default walltime. It also specifies that this job can be shared with
     himself and without a constraint on the job name.

  2. Once your reservation has begun then you can launch:
     ::

        oarsub -I -l /node=2,walltime=0:50:00 -p 'switch = "nom_du_switch_schedule"'\
        -t 'timesharing=user,*'

     So this job will be scheduled on nodes assigned from the previous reservation.

The "timesharing" oarsub_ command possibilities are enumerated in Timesharing_.

How can a checkpointable job be resubmitted automatically?
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

You have to specify that your job is *idempotent*. So, after a successful
checkpoint, if the job is resubmitted then all will go right and there will have
no problem (like file creation, deletion, ...).

Example:
::
    
    oarsub --checkpoint 600 --signal 2 -t idempotent /path/to/prog

So this job will send a signal *SIGINT* (see *man kill* to know signal
numbers) 10 minutes before the walltime ends. Then if everything goes
well it will be resubmitted.

How to submit a non disturbing job for other users?
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

You can use the *besteffort* job type. Thus your job will be launched only
if there is a hole and will be deleted if another job wants its resources.

Example:
::

    oarsub -t besteffort /path/to/prog

Administrator
-------------

What means the error "Bad configuration option: PermitLocalCommand" when I am using oarsh?
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

For security reasons, on the latest OpenSSH releases you are able to execute
a local command when you are connecting to the remote host and we must
deactivate this option because the oarsh_ wrapper executes the *ssh* command
into the user oar.

So if you encounter this error message it means that your OpenSSH does
not know this option and you have to remove it from the oar.conf.
There is a variable named OARSH_OPENSSH_DEFAULT_OPTIONS_ in oar.conf used by oarsh.
So you have just to remove the not yet implemented option.

How to manage start/stop of the nodes?
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
You have to add a script in /etc/init.d which switches resources of the node
into the "Alive" or "Absent" state.
So when this script is called at boot time, it will change the state into
"Alive". And when it is called at halt time, it will change into "Absent".

There two ways to perform this action:

 1. Install OAR "oar-libs" part on all nodes. Thus you will be able to launch
    the command oarnodesetting_ (be careful to right configure "oar.conf" with
    database login and password AND to allow network connections on this
    database).
    So you can execute::

        oarnodesetting -s Alive -h node_hostname
            or
        oarnodesetting -s Absent -h node_hostname

 2. You do not want to install anything else on each node. So you have to
    enable oar user to connect to the server via ssh (for security you
    can use another SSH key with restrictions on the command that oar can
    launch with this one). Thus you will have in you init script
    something like::

        sudo -u oar ssh oar-server "oarnodesetting -s Alive -h node_hostname"
            or
        sudo -u oar ssh oar-server "oarnodesetting -s Absent -h node_hostname"

    In this case, further OAR software upgrade will be more painless.

How can I manage scheduling queues?
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
see oarnotify_.

How can I handle licence tokens?
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
OAR does not manage resources with an empty "network_address". So you can
define resources that are not linked with a real node.

So the steps to configure OAR with the possibility to reserve licences (or
whatever you want that are other notions):

 1. Add a new field in the table resources_ to specify the licence name.
    ::

        oarproperty -a licence -c

 2. Add your licence name resources with oarnodesetting_.
    ::

        oarnodesetting -a -h "" -p type=mathlab -p licence=l1
        oarnodesetting -a -h "" -p type=mathlab -p licence=l2
        oarnodesetting -a -h "" -p type=fluent -p licence=l1
        ...

 3. Now you have to write an admission rule to force oarsub_ "-l" option on
    resources of the type "default" (node resources) if there is no other
    specifications. 
    ::

        INSERT INTO admission_rules (rule) VALUES ('
        foreach my $mold (@{$ref_resource_list}){
            foreach my $r (@{$mold->[0]}){
                my $prop = $r->{property};
                if (($prop !~ /[\\s\\(]type[\\s=]/) and ($prop !~ /^type[\\s=]/)){
                    if (!defined($prop)){
                        $r->{property} = "type = \\\'default\\\'";
                    }else{
                        $r->{property} = "($r->{property}) AND type = \\\'default\\\'";
                    }
                }
            }
        }
        print("[ADMISSION RULE] Modify resource description with type constraints\\n");
        ');

After this configuration, users can perform submissions like
::

    oarsub -I -l "/switch=2/nodes=10+{type = 'mathlab'}/licence=20"

So users ask OAR to give them some other resource types but nothing block
their program to take more licences than they asked.
You can resolve this problem with the SERVER_SCRIPT_EXEC_FILE_ configuration.
In these files you have to bind OAR allocated resources to the licence servers
to restrict user consumptions to what they asked. This is very dependant of
the licence management.

How can I handle multiple clusters with one OAR?
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
These are the steps to follow:

 1. create a resource property to identify the corresponding cluster (like "cluster")::

        oarproperty -a cluster

    (you can see this new property when you use oarnodes_)

 2. with oarnodesetting_ you have to fill this field for all resources; for example::
 
        oarnodesetting -h node42.cluster1.com -p cluster=1
        oarnodesetting -h node43.cluster1.com -p cluster=1
        oarnodesetting -h node2.cluster2.com -p cluster=2
        ...

 3. create 2 new queues with oarnotify_::

        oarnotify  --add_queue "cluster1,5"
        oarnotify  --add_queue "cluster2,5"

 4. Then you have to restrict properties for each queue. So an admission rule performs this job (this is a SQL syntax to use in a database interpreter)::

        INSERT IGNORE INTO admission_rules (rule) VALUES ('
        my $cluster_constraint = 0;
        if ($queue_name eq "cluster1"){
            $cluster_constraint = 1;
        }elsif ($queue_name eq "cluster2"){
            $cluster_constraint = 2;
        }else{
            die("[ADMISSION RULE] Error : you must use the queue cluster1 or the queue cluster2.\\n");
        }
        if ($jobproperties ne ""){
            $jobproperties = "($jobproperties) AND cluster = $cluster_constraint";
        }else{
            $jobproperties = "cluster = $cluster_constraint";
        }
        print("[ADMISSION RULE] Added automatically cluster resource constraint\\n");
        ');

So when you will use oarsub_ to submit on the queue "cluster2" only resources
with the property "cluster=2" is used. This is the same when you will use the
"cluster1" queue.

How to enable jobs to connect to the frontales from the nodes using oarsh?
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
First you have to register the frontales into the database using
oarnodesetting_ with the "frontale" (for example) type and assigned the desired
cpus into the cpuset field; for example::

    oarnodesetting -a -h frontal1 -p type=frontale -p cpuset=0
    oarnodesetting -a -h frontal1 -p type=frontale -p cpuset=1
    oarnodesetting -a -h frontal2 -p type=frontale -p cpuset=0
    ...

Thus you will be able to see resources identifier of these resources with
oarnodes_; try to type::

    oarnodes --sql "type='frontale'"
    
Then put this type name (here "frontale") into the *oar.conf* file on the OAR
server into the tag SCHEDULER_RESOURCES_ALWAYS_ASSIGNED_TYPE_.

Notes:
 - if one of these resources become "Suspected" then the scheduling will
   stop.
 - you can disable this feature with oarnodesetting_ and put these resources
   into the "Absent" state.

A job remains in the "Finishing" state, what can I do?
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
If you have waited more than a couple of minutes (3mn for example) then
something wrong occurred (frontal has crashed, out of memory, ...).

So you are able to turn manually a job into the "Error" state by typing in
the OAR install directory (example with a bash shell)::

    export OARCONFFILE=/etc/oar.conf
    perl -e 'use oar_iolib; $db = iolib::connect(); iolib::set_job_state($db,42,"Error")'

(Replace 42 by your job identifier)

How can I write my own scheduler?
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
.. include:: Scheduler/README

Does OAR handle summer and winter hours?
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
No.

If you change the server time when OAR is executing jobs then their stop date
will be wrong. So users have to be warned about this feature and database logs
are not exact for these jobs.

What is the syntax of this documentation?
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

We are using the RST format from the `Docutils
<http://docutils.sourceforge.net/>`_ project. This syntax is easily readable
and can be converted into HTML, LaTex or XML.

You can find basic informations on
http://docutils.sourceforge.net/docs/user/rst/quickref.html

