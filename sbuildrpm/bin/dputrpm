#!/bin/bash

SRPM=$1
if ! [ -n "$SRPM" -a -r "$SRPM" ] && [[ $SRPM =~ ^.*\/oar-[[:digit:]]+\.[[:digit:]]+\.[[:digit:]]+-[[:digit:]]+\.el[67]\.src\.rpm$ ]]; then 
  cat <<EOF 1>&2
This script takes a OAR SRPM as argument.
EOF
fi

TMP1=${SRPM%.src.rpm}
DIR=${TMP1%/*}/..
TMP2=${TMP1#*/oar-}
EL=${TMP2##*.}
VERSION=${TMP2%.*}
RELEASEBRANCH=${2:-testing}
REMOTE=ftpmaster@oar-ftp.imag.fr.lig

if [ "$RELEASEBRANCH" != "testing" -a "$RELEASEBRANCH" != "stable" ]; then
  echo "Unknown release branch: $RELEASEBRANCH" 1>&2
  exit 1
fi

cat <<EOF
Release branch: $RELEASEBRANCH
Version: $VERSION
EL: $EL
EOF

if [ "$EL" == "el6" ]; then
  DISTRO=centos6
elif [ "$EL" == "el7" ]; then
  DISTRO=centos7
else
  echo "Unknown distribution: $DISTRIB" 1>&2
  exit 1
fi

echo Distro: $DISTRO

read -p "Press a key to continue, or Ctrl-C to abort"

scp $SRPM $DIR/RPMS/*-$VERSION.$EL.*.rpm $REMOTE:oar-ftp.imag.fr/oar/rpm/$DISTRO/$RELEASEBRANCH

ssh $REMOTE "cd oar-ftp.imag.fr/oar/rpm/$DISTRO/$RELEASEBRANCH/ && rpmsign --addsign --key-id D90D0568 *-$VERSION.*.rpm --verbose < /dev/null && createrepo --update --verbose ."

cat <<EOF
Please tag the release and push to remote:
$ git tag -s $DISTRO/$VERSION.$EL -m $DISTRO/$VERSION.$EL
$ git push && git push --tags
EOF
