#!/usr/bin/make -f

# Uncomment this to turn on verbose mode.
#export DH_VERBOSE=1

# This has to be exported to make some magic below work.
export DH_OPTIONS

BUILDDIR=debian

export OARUSER=oar
export OAROWNER=root
export OARCONFDIR=/etc/oar
export PREFIX=/usr
export MANDIR=/usr/share/man
export OARDIR=/usr/lib/oar
export BINDIR=/usr/bin
export SBINDIR=/usr/sbin
export CGIDIR=/usr/lib/cgi-bin
export PERLLIBDIR=/usr/share/perl5
export VARLIBDIR=/var/lib


%:
	dh $@ 

override_dh_auto_build:
	$(MAKE) build

override_dh_auto_install:
	# oar-doc
	$(MAKE) -e -f Makefiles/doc.mk install \
	    DESTDIR=$(CURDIR)/$(BUILDDIR)/oar-doc \
	    DOCDIR=/usr/share/doc/oar-do
	
	# oar-common
	mkdir -p $(CURDIR)/$(BUILDDIR)/oar-common/var/lib/oar	
	$(MAKE) -e -f Makefiles/common.mk install \
	    DESTDIR=$(CURDIR)/$(BUILDDIR)/oar-common
	$(MAKE) -e -f Makefiles/libs.mk install \
	    DESTDIR=$(CURDIR)/$(BUILDDIR)/oar-common
	$(MAKE) -e -f Makefiles/gridlibs.mk install \
	    DESTDIR=$(CURDIR)/$(BUILDDIR)/oar-common
	perl -i -pe 's#^\#?OAR_RUNTIME_DIRECTORY=.*#OAR_RUNTIME_DIRECTORY="/var/lib/oar"#' $(CURDIR)/$(BUILDDIR)/oar-common/etc/oar/oar.conf
	perl -i -pe 's/^\#*OPENSSH_CMD=.*/OPENSSH_CMD="\/usr\/bin\/ssh -p 6667"/' $(CURDIR)/$(BUILDDIR)/oar-common/etc/oar/oar.conf
	
	# oar-server
	mkdir -p $(CURDIR)/$(BUILDDIR)/oar-server/var/lib/oar
	$(MAKE) -e -f Makefiles/server.mk install\
                DESTDIR=$(CURDIR)/$(BUILDDIR)/oar-server
	$(MAKE) -e -f Makefiles/database.mk install\
                DESTDIR=$(CURDIR)/$(BUILDDIR)/oar-server
	
	# oar-node
	mkdir -p $(CURDIR)/$(BUILDDIR)/oar-node/var/lib/oar
	mkdir -p $(CURDIR)/$(BUILDDIR)/oar-node/etc/init.d
	$(MAKE) -e -f Makefiles/node.mk install\
                DESTDIR=$(CURDIR)/$(BUILDDIR)/oar-node
	
	# oar-user
	mkdir -p $(CURDIR)/$(BUILDDIR)/oar-user/var/lib/oar
	$(MAKE) -e -f Makefiles/user.mk install\
                DESTDIR=$(CURDIR)/$(BUILDDIR)/oar-user
	
	# oar-web-status
	$(MAKE) -e -f Makefiles/monika.mk install \
                DESTDIR=$(CURDIR)/$(BUILDDIR)/oar-web-status \
		WWWDIR=/usr/share/oar-web-status
	$(MAKE) -e -f Makefiles/poar.mk install \
                DESTDIR=$(CURDIR)/$(BUILDDIR)/oar-web-status \
		WWWDIR=/usr/share/oar-web-status
	$(MAKE) -e -f Makefiles/draw-gantt.mk install \
                DESTDIR=$(CURDIR)/$(BUILDDIR)/oar-web-status \
		WWWDIR=/usr/share/oar-web-status
	$(MAKE) -e -f Makefiles/www-conf.mk install \
                DESTDIR=$(CURDIR)/$(BUILDDIR)/oar-web-status \
		WWWDIR=/usr/share/oar-web-status
	
	# oar-admin
	$(MAKE) -e -f Makefiles/tools.mk install \
                DESTDIR=$(CURDIR)/$(BUILDDIR)/oar-admin
	
	# oar-desktop-computing-agent
	$(MAKE) -e -f Makefiles/desktop-computing-agent.mk install \
                DESTDIR=$(CURDIR)/$(BUILDDIR)/oar-desktop-computing-agent
	
	# oar-desktop-computing-cgi
	$(MAKE) -e -f Makefiles/desktop-computing-cgi.mk install \
                DESTDIR=$(CURDIR)/$(BUILDDIR)/oar-desktop-computing-cgi
	
	# api
	$(MAKE) -e -f Makefiles/api.mk install \
	    DESTDIR=$(CURDIR)/$(BUILDDIR)/oar-api \
	    DOCDIR=/usr/share/doc/oar-api
	
	# gridapi
	$(MAKE) -e -f Makefiles/gridapi.mk install \
	    DESTDIR=$(CURDIR)/$(BUILDDIR)/oar-gridapi \
	    DOCDIR=/usr/share/doc/oar-gridapi
	
	# keyring
	$(MAKE) -e -f Makefiles/keyring.mk install \
	    DESTDIR=$(CURDIR)/$(BUILDDIR)/oar-keyring \
	    DOCDIR=/usr/share/doc/oar-keyring
	
	# ocaml-sheduler-mysql
	$(MAKE) -e -f Makefiles/ocaml-schedulers.mk install \
	    DESTDIR=$(CURDIR)/$(BUILDDIR)/oar-sheduler-mysql

	dh_install -i
