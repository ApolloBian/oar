#!/bin/bash
#
# In sshd_config you must have this line :
#     AcceptEnv OAR_CPUSET SUDO_USER
# User to become is in $SUDO_USER
# $OAR_CPUSET contains the cpuset name

# if "oarstat" command is not in the PATH then change into the full
# install command path
OARSTAT_CMD="oarstat"

# Get the name of the current cpuset #
function get_current_cpuset() {
    CPUSETFILE=/proc/self/cpuset

    if [ -r $CPUSETFILE ]
    then
        echo $(< $CPUSETFILE)
    fi
}
######################################

export OAR_CPUSET

OAR_CPUSET=$(get_current_cpuset)
if [ "$OAR_CPUSET" == "" ] || [ "$OAR_CPUSET" == "/" ]
then
    if [ $OARSH_JOB_ID -gt 0 ]
    then
        OAR_CPUSET=$($OARSTAT_CMD -fj $OARSH_JOB_ID | grep "^    cpuset_name = " | cut -d " " -f 7)
        if [ "$OAR_CPUSET" == "" ] 
        then
            echo "[OARSH] Cannot get the OAR job cpuset name." 1>&2
            echo "[OARSH] So you are not on a computing node and the job $OARSH_JOB_ID does not exist." 1>&2
            exit 1
        else
            echo $OAR_CPUSET | grep $SUDO_USER"_" &> /dev/null
            if [ $? -ne 0 ]
            then
                echo "[OARSH] Cannot get the OAR job cpuset name." 1>&2
                echo "[OARSH] So you are not on a computing node and the job $OARSH_JOB_ID is not yours." 1>&2
                exit 2
            fi
        fi
    else
        echo "[OARSH] Cannot get the OAR job cpuset name" 1>&2
        echo "[OARSH] AND there is no OARSH_JOB_ID environment variable defined." 1>&2
        exit 3
    fi
fi

exec ssh -oSendEnv="OAR_CPUSET SUDO_USER" "$@"

