#!/bin/bash
#
# This is the shell program used with the oarsh script.
# It adds its own process in the cpuset OAR_CPUSET and launches
# the shell or the script of the user SUDO_USER.

DEFAULT_SHELL=/bin/bash

if [ "$SUDO_USER" == "" ]
then
    # It must be oar
    export SHELL=$DEFAULT_SHELL
    exec $DEFAULT_SHELL "$@"
else
    # CPUSET assignation
    CPUSET_MOUNT_POINT=$(mount -t cpuset | cut -d " " -f 3 | head -1)
    CPUSETFILE="$CPUSET_MOUNT_POINT/$OAR_CPUSET/tasks"
    
    if ( ! $(sudo test -w $CPUSETFILE) )
    then
        echo "[OARSH] Cannot find cpuset file : $CPUSETFILE" 1>&2
        exit 1
    fi
    MY_PID=$$
    sudo sh -c "echo $MY_PID > $CPUSETFILE"
            
    if [ "$1" == "" ]
    then
        # Simulate initial login
        exec sudo -i -u $SUDO_USER
    else
        # Get user shell (must be optimized)
        PASSWD_LINE=$(getent passwd $SUDO_USER)
        export SHELL=$(echo $PASSWD_LINE | cut -d : -f 7)
        if [ "$SHELL" == "" ]
        then
            echo "[OARSH_SHELL] ERROR: No shell found for user $SUDO_USER." 1>&2
            exit 1
        else
            export HOME=$(echo $PASSWD_LINE | cut -d : -f 6)
            cd $HOME
            exec sudo -H -u $SUDO_USER $SHELL "$@"
        fi
    fi
fi
